name: Fetch Modify Config

on:
  schedule:
    - cron: '0 13 * * *' # UTC æ—¶é—´ 13:00 å¯¹åº”åŒ—äº¬æ—¶é—´ 21:00
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  process-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and modify config file
        run: |
          # å®šä¹‰æºæ–‡ä»¶ URL å’Œç›®æ ‡æ–‡ä»¶è·¯å¾„
          SOURCE_URL="https://raw.githubusercontent.com/cmliu/ACL4SSR/main/Clash/config/ACL4SSR_Online_MultiCountry.ini"
          DEST_FILE="ACL4SSR_Online_MultiCountry_all.ini"

          # ä» URL ä¸‹è½½æ–‡ä»¶å†…å®¹
          echo "Fetching config from $SOURCE_URL..."
          if ! curl -sSL "$SOURCE_URL" -o "$DEST_FILE.tmp"; then
            echo "Error: Failed to fetch config file"
            exit 1
          fi

          # åˆ é™¤åŒ…å«æŒ‡å®šä»£ç†ç»„çš„è¡Œ
          echo "Modifying config file..."
          sed -i '/custom_proxy_group=â˜‘ï¸ æ‰‹åŠ¨åˆ‡æ¢/d' "$DEST_FILE.tmp"
          sed -i '/custom_proxy_group=ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹/d' "$DEST_FILE.tmp"
          sed -i '/custom_proxy_group=ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹/d' "$DEST_FILE.tmp"
          sed -i '/custom_proxy_group=ğŸ‡ºğŸ‡² ç¾å›½èŠ‚ç‚¹/d' "$DEST_FILE.tmp"

          # åˆ é™¤æ–‡ä»¶ä¸­æ‰€æœ‰å‡ºç°çš„ç‰¹å®šæ ‡è®°
          sed -i 's/\[]â˜‘ï¸ æ‰‹åŠ¨åˆ‡æ¢//g' "$DEST_FILE.tmp"
          sed -i 's/\[]ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹//g' "$DEST_FILE.tmp"
          sed -i 's/\[]ğŸ‡ºğŸ‡² ç¾å›½èŠ‚ç‚¹//g' "$DEST_FILE.tmp"

          # ç§»åŠ¨å¤„ç†åçš„æ–‡ä»¶åˆ°ç›®æ ‡è·¯å¾„
          mv "$DEST_FILE.tmp" "$DEST_FILE"

          echo "File processed successfully"

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Update ACL4SSR_Online_MultiCountry_all.ini (daily sync)'
          file_pattern: 'ACL4SSR_Online_MultiCountry_all.ini'
